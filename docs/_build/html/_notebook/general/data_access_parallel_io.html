

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Performance Examples of Accessing Data: Parallel IO &mdash; NCI data training  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> NCI data training
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../_overview/overview.html">Overview</a></li>
</ul>
<p class="caption"><span class="caption-text">Data Info</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../_data/where_to_find_data.html">Where to Find Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_data/where_to_get_data.html">Where to Get Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_data/how_to_use_data.html">How to Use Data</a></li>
</ul>
<p class="caption"><span class="caption-text">How to run Jupyter notebooks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../prep/install_jupyter.html">Install Jupyter and Python on your local machine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../prep/python_on_vdi.html">Setup Python environment on the VDI</a></li>
</ul>
<p class="caption"><span class="caption-text">Notebook examples grouped by theme</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../climate/climate.html">Climate and Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../eo/eo.html">Earth Observation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../geophysics/geophysics.html">Geophysics</a></li>
<li class="toctree-l1"><a class="reference internal" href="general.html">Other examples</a></li>
</ul>
<p class="caption"><span class="caption-text">Notebook examples grouped by service type</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tds/tds.html">THREDDS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gsky/gsky.html">GSKY</a></li>
</ul>
<p class="caption"><span class="caption-text">Help</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../_help/help.html">Help</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">NCI data training</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>Performance Examples of Accessing Data: Parallel IO</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/_notebook/general/data_access_parallel_io.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 5ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<p><img alt="logo" src="../../_images/NCI_logo2.png" /></p>
<hr class="docutils" />
<div class="section" id="Performance-Examples-of-Accessing-Data:-Parallel-IO">
<h1>Performance Examples of Accessing Data: Parallel IO<a class="headerlink" href="#Performance-Examples-of-Accessing-Data:-Parallel-IO" title="Permalink to this headline">¶</a></h1>
<hr class="docutils" />
<p>In this notebook:</p>
<p>We will demonstrate how to conduct the parallel IO in python by using multiprocessing module and MPI.</p>
<p>There are three ways to do concurrent programming in Python: threads, the multiprocessing module, and the Message Passing Interface (MPI).</p>
<p>Python itself includes a single master lock that governs access to the interpreterâs functions, called the Global Interpreter Lock or GIL. This lock serializes access from multiple threads to basic resources like object reference counting. We can have as many threads as we like in a Python program, but only one at a time can use the interpreter. Thus we canât use more than one coreâs worth of time when running a pure-Python program. Thread-based code is fine for GUIs and applications that
call into external libraries that don’t tie up the Python interpreter. <img alt="1" src="../../_images/threads.png" /></p>
<p>Multiprocessing provides support for basic fork()-based parallel processing. Itâs the simplest way in Python to write parallel code that uses more than one core, and strongly recommended for general-purpose computation.However, the parallel processes canât share a single NetCDF4/HDF5 file, even if the file is opened read only. Alternatively, multiprocessing could be used to open multiple files respectively or doing computation in parallel and doing IO in serial. <img alt="2" src="../../_images/multiple_process.png" /></p>
<p>MPI-based Parallel HDF5 is by far the best way to do parallel IO on NetCDF4/HDF5 files. MPI is the official flavor of parallelism supported by the HDF5 library. You can have an unlimited number of processes, all of which share the same open HDF5 file. All of them can read and write data, and modify the fileâs structure. Programs written this way require a little more care, but it is the most elegant and highest-performance way to use HDF5 in a parallel context. <img alt="3" src="../../_images/mpi_hdf5.png" /></p>
<p>The following material uses CSIRO IMOS/TERN MODIS Data Collection which is available under the Create Commons License 4.0 through NCI’s THREDDS Data Server. For more information on the collection and licensing, please <a class="reference external" href="http://geonetwork.nci.org.au/geonetwork/srv/eng/catalog.search#/metadata/f3633_7369_2730_8213">click here</a>.</p>
<hr class="docutils" />
<div class="section" id="Prerequisites">
<h2>Prerequisites<a class="headerlink" href="#Prerequisites" title="Permalink to this headline">¶</a></h2>
<p>Please load the following modules:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">module</span> <span class="n">load</span> <span class="n">python3</span><span class="o">/</span><span class="mf">3.5</span><span class="o">.</span><span class="mi">2</span>
<span class="n">module</span> <span class="n">load</span> <span class="n">python3</span><span class="o">/</span><span class="mf">3.5</span><span class="o">.</span><span class="mi">2</span><span class="o">-</span><span class="n">matplotlib</span>
<span class="n">module</span> <span class="n">load</span> <span class="n">ipython</span><span class="o">/</span><span class="mf">4.2</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">py3</span><span class="o">.</span><span class="mi">5</span>
<span class="n">module</span> <span class="n">load</span> <span class="n">netcdf4</span><span class="o">-</span><span class="n">python</span><span class="o">/</span><span class="mf">1.2</span><span class="o">.</span><span class="mi">4</span><span class="o">-</span><span class="n">py3</span><span class="o">.</span><span class="mi">5</span>
<span class="n">module</span> <span class="n">load</span> <span class="n">h5py</span><span class="o">/</span><span class="mf">2.6</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">hdf5</span><span class="o">-</span><span class="mf">1.8</span><span class="o">.</span><span class="mi">14</span><span class="o">-</span><span class="n">py3</span><span class="o">.</span><span class="mi">5</span>
</pre></div>
</div>
<div class="section" id="Multiple-processes-read-multiple-files">
<h3>Multiple processes read multiple files<a class="headerlink" href="#Multiple-processes-read-multiple-files" title="Permalink to this headline">¶</a></h3>
<p>Order matters here, netCDF4 needs to be loaded following the h5py.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">commands</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="k">import</span> <span class="n">Pool</span><span class="p">,</span><span class="n">current_process</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="k">import</span> <span class="n">MPI</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.image</span> <span class="k">as</span> <span class="nn">mpimg</span>
<span class="kn">import</span> <span class="nn">h5py</span>
<span class="k">global</span> <span class="n">tmp_file</span>
<span class="kn">from</span> <span class="nn">netCDF4</span> <span class="k">import</span> <span class="n">Dataset</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">ModuleNotFoundError</span>                       Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-1-adef24619f8d&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      2</span> <span class="ansi-green-fg">import</span> time
<span class="ansi-green-intense-fg ansi-bold">      3</span> <span class="ansi-green-fg">import</span> sys
<span class="ansi-green-fg">----&gt; 4</span><span class="ansi-red-fg"> </span><span class="ansi-green-fg">import</span> commands
<span class="ansi-green-intense-fg ansi-bold">      5</span> <span class="ansi-green-fg">from</span> multiprocessing <span class="ansi-green-fg">import</span> Pool<span class="ansi-blue-fg">,</span>current_process
<span class="ansi-green-intense-fg ansi-bold">      6</span> <span class="ansi-green-fg">import</span> numpy <span class="ansi-green-fg">as</span> np

<span class="ansi-red-fg">ModuleNotFoundError</span>: No module named &#39;commands&#39;
</pre></div></div>
</div>
</div>
</div>
<div class="section" id="Useful-functions">
<h2>Useful functions<a class="headerlink" href="#Useful-functions" title="Permalink to this headline">¶</a></h2>
<p>Print the metadata of a variable</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">view_prt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">varname</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">):</span>
    <span class="n">f</span><span class="o">=</span><span class="n">Dataset</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;File Name: </span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Format: </span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">f</span><span class="o">.</span><span class="n">data_model</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">dimensions</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;dimension </span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">f</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    &#39;</span><span class="p">)</span>
    <span class="nb">vars</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">varname</span><span class="o">==</span><span class="s1">&#39;all&#39;</span> <span class="ow">or</span> <span class="n">item</span><span class="o">==</span><span class="n">varname</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Variable: </span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Dimensions: </span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">dimensions</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Shape:    </span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;size:  </span><span class="se">\t\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;data type:  </span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;chunksize: </span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">chunking</span><span class="p">())</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;tendian: </span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">endian</span><span class="p">())</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;filters: </span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">filters</span><span class="p">())</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ncattrs: </span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">ncattrs</span><span class="p">())</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Multiprocessing-module-example">
<h2>Multiprocessing module example<a class="headerlink" href="#Multiprocessing-module-example" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">doubler</span><span class="p">(</span><span class="n">number</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A doubling function that can be used by a process</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">number</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="n">proc_name</span> <span class="o">=</span> <span class="n">current_process</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> doubled to </span><span class="si">{1}</span><span class="s1"> by: </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">number</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">proc_name</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">number</span><span class="o">*</span><span class="mi">2</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>
<span class="n">numbers</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
<span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">doubler</span><span class="p">,</span> <span class="n">numbers</span><span class="p">))</span>
<span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-green-fg">&lt;timed exec&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>

<span class="ansi-red-fg">NameError</span>: name &#39;Pool&#39; is not defined
</pre></div></div>
</div>
</div>
<div class="section" id="Example-Dataset--MODIS">
<h2>Example Dataset- MODIS<a class="headerlink" href="#Example-Dataset--MODIS" title="Permalink to this headline">¶</a></h2>
<p><p>The MOD10A1 daily product is gridded in equal area tiles. Each tile consists of a 1200 km by 1200 km data array, which corresponds to 2400 by 2400 cells at 500 m resolution. The following image shows tile locations for MOD10A1 V005 data in a sinusoidal projection.</p>
</p><p><a class="reference external" href="https://modis-land.gsfc.nasa.gov/MODLAND_grid.html">https://modis-land.gsfc.nasa.gov/MODLAND_grid.html</a></p>
<p><img alt="4" src="../../_images/phdf5_layers.png" /></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">multi_read_wrapper</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">read_var</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">read_var</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="mi">2400</span><span class="p">):</span>
    <span class="n">proc_name</span> <span class="o">=</span> <span class="n">current_process</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;read variable </span><span class="si">{0}</span><span class="s1"> of file </span><span class="si">{1}</span><span class="s1"> by: </span><span class="si">{2}</span><span class="s1"> from </span><span class="si">{3}</span><span class="s1"> to </span><span class="si">{4}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">varname</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span> <span class="n">proc_name</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">))</span>
    <span class="n">fr</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;NETCDF4&#39;</span><span class="p">)</span>
    <span class="n">out</span><span class="o">=</span><span class="n">fr</span><span class="p">[</span><span class="n">varname</span><span class="p">][:,:,</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
    <span class="n">fr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#filename=&#39;/g/data/u39/public/prep/modis-fc/FC.v302.MCD43A4/FC.v302.MCD43A4.h24v05.2000.005.nc&#39;</span>
<span class="n">filename</span><span class="o">=</span><span class="s1">&#39;http://dapds00.nci.org.au/thredds/dodsC/u39/public/prep/modis-fc/FC.v302.MCD43A4/FC.v302.MCD43A4.h24v05.2000.005.nc&#39;</span>
<span class="n">varname</span><span class="o">=</span><span class="s1">&#39;bare_soil&#39;</span>
<span class="n">view_prt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">varname</span><span class="p">)</span>
<span class="n">filename</span><span class="o">=</span><span class="s1">&#39;http://dapds00.nci.org.au/thredds/dodsC/u39/public/prep/modis-fc/FC.v302.MCD43A4/FC.v302.MCD43A4.h24v05.2001.005.nc&#39;</span>
<span class="n">varname</span><span class="o">=</span><span class="s1">&#39;bare_soil&#39;</span>
<span class="n">view_prt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">varname</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-6-99fcc412ea7a&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      2</span> filename<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">&#39;http://dapds00.nci.org.au/thredds/dodsC/u39/public/prep/modis-fc/FC.v302.MCD43A4/FC.v302.MCD43A4.h24v05.2000.005.nc&#39;</span>
<span class="ansi-green-intense-fg ansi-bold">      3</span> varname<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">&#39;bare_soil&#39;</span>
<span class="ansi-green-fg">----&gt; 4</span><span class="ansi-red-fg"> </span>view_prt<span class="ansi-blue-fg">(</span>filename<span class="ansi-blue-fg">,</span>varname<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">      5</span> filename<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">&#39;http://dapds00.nci.org.au/thredds/dodsC/u39/public/prep/modis-fc/FC.v302.MCD43A4/FC.v302.MCD43A4.h24v05.2001.005.nc&#39;</span>
<span class="ansi-green-intense-fg ansi-bold">      6</span> varname<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">&#39;bare_soil&#39;</span>

<span class="ansi-green-fg">&lt;ipython-input-2-6412b0d2f08b&gt;</span> in <span class="ansi-cyan-fg">view_prt</span><span class="ansi-blue-fg">(filename, varname)</span>
<span class="ansi-green-intense-fg ansi-bold">      1</span> <span class="ansi-green-fg">def</span> view_prt<span class="ansi-blue-fg">(</span>filename<span class="ansi-blue-fg">,</span>varname<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">&#39;all&#39;</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">----&gt; 2</span><span class="ansi-red-fg">     </span>f<span class="ansi-blue-fg">=</span>Dataset<span class="ansi-blue-fg">(</span>filename<span class="ansi-blue-fg">,</span><span class="ansi-blue-fg">&#39;r&#39;</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">      3</span>     print<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;File Name: \t&#39;</span><span class="ansi-blue-fg">,</span>filename<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">      4</span>     print<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;Format: \t&#39;</span><span class="ansi-blue-fg">,</span>f<span class="ansi-blue-fg">.</span>data_model<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">      5</span>     <span class="ansi-green-fg">for</span> item <span class="ansi-green-fg">in</span> f<span class="ansi-blue-fg">.</span>dimensions<span class="ansi-blue-fg">:</span>

<span class="ansi-red-fg">NameError</span>: name &#39;Dataset&#39; is not defined
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">path</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">2008</span><span class="p">):</span>
    <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;http://dapds00.nci.org.au/thredds/dodsC/u39/public/prep/modis-fc/FC.v302.MCD43A4/FC.v302.MCD43A4.h24v05.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.005.nc&#39;</span>
    <span class="n">varname</span><span class="o">=</span><span class="s1">&#39;bare_soil&#39;</span>
    <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">filename</span><span class="p">,</span><span class="n">varname</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>
<span class="n">nprocs</span><span class="o">=</span><span class="mi">1</span>
<span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">nprocs</span><span class="p">)</span>
<span class="n">val</span><span class="o">=</span><span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">multi_read_wrapper</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
<span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-green-fg">&lt;timed exec&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>

<span class="ansi-red-fg">NameError</span>: name &#39;Pool&#39; is not defined
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>
<span class="n">nprocs</span><span class="o">=</span><span class="mi">2</span>
<span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">nprocs</span><span class="p">)</span>
<span class="n">val</span><span class="o">=</span><span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">multi_read_wrapper</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
<span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-green-fg">&lt;timed exec&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>

<span class="ansi-red-fg">NameError</span>: name &#39;Pool&#39; is not defined
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>
<span class="n">nprocs</span><span class="o">=</span><span class="mi">4</span>
<span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">nprocs</span><span class="p">)</span>
<span class="n">val</span><span class="o">=</span><span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">multi_read_wrapper</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
<span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-green-fg">&lt;timed exec&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>

<span class="ansi-red-fg">NameError</span>: name &#39;Pool&#39; is not defined
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>
<span class="n">val</span><span class="o">=</span><span class="p">[]</span>
<span class="n">paths</span><span class="o">=</span><span class="p">[]</span>

<span class="n">nprocs</span><span class="o">=</span><span class="mi">4</span>
<span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">nprocs</span><span class="p">)</span>

<span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">2008</span><span class="p">):</span>
    <span class="n">args</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;http://dapds00.nci.org.au/thredds/dodsC/u39/public/prep/modis-fc/FC.v302.MCD43A4/FC.v302.MCD43A4.h24v05.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.005.nc&#39;</span>
    <span class="n">varname</span><span class="o">=</span><span class="s1">&#39;bare_soil&#39;</span>
    <span class="n">f</span><span class="o">=</span><span class="n">Dataset</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">dimns</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">for</span> <span class="n">iproc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nprocs</span><span class="p">):</span>
        <span class="n">start</span><span class="o">=</span><span class="n">iproc</span><span class="o">*</span><span class="n">dimns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">nprocs</span>
        <span class="n">end</span><span class="o">=</span><span class="p">(</span><span class="n">iproc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dimns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">nprocs</span>
        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;bare_soil&#39;</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">))</span>
    <span class="n">val</span><span class="o">=</span><span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">multi_read_wrapper</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
<span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-green-fg">&lt;timed exec&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>

<span class="ansi-red-fg">NameError</span>: name &#39;Pool&#39; is not defined
</pre></div></div>
</div>
</div>
<div class="section" id="Multiple-processes-accessing-a-single-file-(Parallel-HDF5)">
<h2>Multiple processes accessing a single file (Parallel HDF5)<a class="headerlink" href="#Multiple-processes-accessing-a-single-file-(Parallel-HDF5)" title="Permalink to this headline">¶</a></h2>
<p><img alt="4" src="../../_images/phdf5_layers.png" /></p>
<p>This is typical scheme when working on Raijin with the Lustre file system. On VDI, we simply employed the local storage or NFS which may give rise to different IO performance characteristics.</p>
<p><p>application: parallel_io.py</p>
</p><li><p>argv[1] = 1 (collective) or 0 (independent)</p>
</li><li><p>argv[2] = file name</p>
</li><li><p>argv[3] = variable name</p>
</li><li><p>argv[4] = 0,1,2 the dimension index to be splitted among MPI ranks</p>
</li><div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>
<span class="n">val</span><span class="o">=</span><span class="p">[]</span>
<span class="n">paths</span><span class="o">=</span><span class="p">[]</span>

<span class="n">nprocs</span><span class="o">=</span><span class="s1">&#39; 2&#39;</span>
<span class="n">along_dim</span><span class="o">=</span><span class="s1">&#39; 1&#39;</span>
<span class="n">prog_name</span><span class="o">=</span><span class="s2">&quot; python parallel_io.py&quot;</span>
<span class="n">collective</span><span class="o">=</span><span class="s1">&#39; 0&#39;</span>

<span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">2008</span><span class="p">):</span>
    <span class="n">args</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;http://dapds00.nci.org.au/thredds/dodsC/u39/public/prep/modis-fc/FC.v302.MCD43A4/FC.v302.MCD43A4.h24v05.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.005.nc&#39;</span>
    <span class="n">varname</span><span class="o">=</span><span class="s1">&#39; bare_soil&#39;</span>
    <span class="n">cmd_line</span><span class="o">=</span><span class="s2">&quot;mpirun -np &quot;</span><span class="o">+</span><span class="n">nprocs</span><span class="o">+</span><span class="n">prog_name</span><span class="o">+</span><span class="n">collective</span><span class="o">+</span><span class="n">filename</span><span class="o">+</span><span class="n">varname</span><span class="o">+</span><span class="n">along_dim</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">cmd_line</span><span class="p">)</span>
    <span class="n">out</span><span class="o">=</span><span class="n">commands</span><span class="o">.</span><span class="n">getoutput</span><span class="p">(</span><span class="n">cmd_line</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
mpirun -np  2 python parallel_io.py 0http://dapds00.nci.org.au/thredds/dodsC/u39/public/prep/modis-fc/FC.v302.MCD43A4/FC.v302.MCD43A4.h24v05.2000.005.nc bare_soil 1
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-green-fg">&lt;timed exec&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>

<span class="ansi-red-fg">NameError</span>: name &#39;commands&#39; is not defined
</pre></div></div>
</div>
<p><p>MPI has two flavors of operation: collective, which means that all processes have to participate (and in the same order), and independent, which means each process can perform the operation (or not) whenever and in whatever order it pleases.</p>
</p><p>With NetCDF4/HDF5, the modifications to file metadata must be done collectively, such as:</p>
<li><p>Opening or closing a file</p>
</li><li><p>Creating or deleting new datasets, groups, attributes, or named types</p>
</li><li><p>Changing a dataset shape</p>
</li><li><p>Moving or copying objects in the file</p>
</li><p><img alt="6" src="../../_images/parallel_access_x.png" /></p>
<p><img alt="7" src="../../_images/parallel_access_y.png" /></p>
<p>Collective calls can effectively reduce the number of IO operations for non-contiguous access. Collective calls means all processes of the communicator must participate in calls in the right order. <img alt="8" src="../../_images/collective.png" /></p>
<p><p>application: collective_io.py</p>
</p><li><p>argv[1]=col (collective) or idp (independent)</p>
</li><li><p>argv[2]=x (contiguous access) or y (non-contiguous access)</p>
</li><div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">val</span><span class="o">=</span><span class="p">[]</span>
<span class="n">paths</span><span class="o">=</span><span class="p">[]</span>

<span class="n">nprocs</span><span class="o">=</span><span class="s1">&#39; 4&#39;</span>
<span class="n">prog_name</span><span class="o">=</span><span class="s2">&quot; python collective_io.py&quot;</span>

<span class="k">for</span> <span class="n">col_idp</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39; col&#39;</span><span class="p">,</span><span class="s1">&#39; idp&#39;</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">along_dim</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39; y&#39;</span><span class="p">,</span><span class="s1">&#39; x&#39;</span><span class="p">]:</span>
        <span class="n">cmd_line</span><span class="o">=</span><span class="s2">&quot;mpirun -np &quot;</span><span class="o">+</span><span class="n">nprocs</span><span class="o">+</span><span class="n">prog_name</span><span class="o">+</span><span class="n">col_idp</span><span class="o">+</span><span class="n">along_dim</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">cmd_line</span><span class="p">)</span>
        <span class="n">out</span><span class="o">=</span><span class="n">commands</span><span class="o">.</span><span class="n">getoutput</span><span class="p">(</span><span class="n">cmd_line</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
mpirun -np  4 python collective_io.py col y
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-13-5866537fa5bd&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      9</span>         cmd_line<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">&#34;mpirun -np &#34;</span><span class="ansi-blue-fg">+</span>nprocs<span class="ansi-blue-fg">+</span>prog_name<span class="ansi-blue-fg">+</span>col_idp<span class="ansi-blue-fg">+</span>along_dim
<span class="ansi-green-intense-fg ansi-bold">     10</span>         print<span class="ansi-blue-fg">(</span>cmd_line<span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">---&gt; 11</span><span class="ansi-red-fg">         </span>out<span class="ansi-blue-fg">=</span>commands<span class="ansi-blue-fg">.</span>getoutput<span class="ansi-blue-fg">(</span>cmd_line<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     12</span>         print<span class="ansi-blue-fg">(</span>out<span class="ansi-blue-fg">)</span>

<span class="ansi-red-fg">NameError</span>: name &#39;commands&#39; is not defined
</pre></div></div>
</div>
</div>
</div>
<div class="section" id="References">
<h1>References<a class="headerlink" href="#References" title="Permalink to this headline">¶</a></h1>
<ul><li><p>‘Parallel HDF5’,Quincey Koziol, The HDF group, 2015.</p>
</li><li><p>‘Portable Parallel I/O: Handling large datasets in heterogeneous parallel environments’, Michael Stephan, JULICH, 2013.</p>
</li><li><p>‘Python and HDF5’,Andrew Collette, 2014.</p>
</li></ul></div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, NCI

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>
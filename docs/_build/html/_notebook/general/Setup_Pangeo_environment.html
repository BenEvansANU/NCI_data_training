

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Setup Pangeo Environment &mdash; NCI data training  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> NCI data training
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../_overview/overview.html">Overview</a></li>
</ul>
<p class="caption"><span class="caption-text">Data Info</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../_data/where_to_find_data.html">Where to Find Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_data/where_to_get_data.html">Where to Get Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_data/how_to_use_data.html">How to Use Data</a></li>
</ul>
<p class="caption"><span class="caption-text">How to run Jupyter notebooks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../prep/install_jupyter.html">Install Jupyter and Python on your local machine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../prep/python_on_vdi.html">Setup Python environment on the VDI</a></li>
</ul>
<p class="caption"><span class="caption-text">Notebook examples grouped by theme</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../climate/climate.html">Climate and Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../eo/eo.html">Earth Observation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../geophysics/geophysics.html">Geophysics</a></li>
<li class="toctree-l1"><a class="reference internal" href="general.html">Other examples</a></li>
</ul>
<p class="caption"><span class="caption-text">Notebook examples grouped by service type</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tds/tds.html">THREDDS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gsky/gsky.html">GSKY</a></li>
</ul>
<p class="caption"><span class="caption-text">Help</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../_help/help.html">Help</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">NCI data training</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>Setup Pangeo Environment</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/_notebook/general/Setup_Pangeo_environment.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<p><img alt="logo" src="../../_images/NCI_logo7.png" /></p>
<hr class="docutils" />
<div class="section" id="Setup-Pangeo-Environment">
<h1>Setup Pangeo Environment<a class="headerlink" href="#Setup-Pangeo-Environment" title="Permalink to this headline">¶</a></h1>
<p>In this notebook:</p>
<ul class="simple">
<li>Load Pangeo module</li>
<li>Activate pangeo enviornment</li>
<li>submit a batch job script to the queue system</li>
<li>Set up port forwarding at the client machine</li>
<li>Connect to the remote Jupyter lab server from client machine</li>
<li>Utilise the dask server in Jupyter notebook</li>
<li>Visulise dask dashboard</li>
<li>Run Jupyter notebook in a batch job</li>
</ul>
<hr class="docutils" />
<p><strong>Pangeo</strong> is a community platform for big data in geoscience, funded by US NSF. Pangeo project serves as a coordination point between scientists, software and computing infrastructure. The Pangeo software ecosystem involves open source tools such as xarray, iris, dask, jupyter, and many other packages. <a class="reference external" href="http://pangeo.io">This site</a> provides guidance for accessing data and performing analysis using these tools. NCI has installed the Pangeo environment on Raijin by following instructions
<a class="reference external" href="http://pangeo.io/setup_guides/hpc.html">here</a>.</p>
<p>Please note that Pangeo will be transferred to Gadi when major Raijin/Gadi transition happens in Nov 2019. This notebook provides instructions on how to use the Pangeo environment to run your jupyter notebook on your desktop and interact with Raijin remotely.</p>
<div class="section" id="Load-Pangeo-module-on-Raijin-and-activate-Pangeo-environment">
<h2>Load Pangeo module on Raijin and activate Pangeo environment<a class="headerlink" href="#Load-Pangeo-module-on-Raijin-and-activate-Pangeo-environment" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ module load pangeo/2019.10
$ source ${PANGEO_ROOT}/etc/profile.d/conda.sh
$ conda activate pangeo
</pre></div>
</div>
<p>You will see pangeo appear in the brackets in front of the prompt. You can quit the enviornment using <strong>conda deactivate</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$conda deactivate
</pre></div>
</div>
<p><img alt="1" src="../../_images/pangeo_setup1.png" /></p>
<p>If you ask where your Python command lives, it should direct you to where pangeo was installed on Raijin.</p>
<p><img alt="2" src="../../_images/pangeo_setup2.png" /></p>
</div>
<div class="section" id="Configure-Jupyter">
<h2>Configure Jupyter<a class="headerlink" href="#Configure-Jupyter" title="Permalink to this headline">¶</a></h2>
<p>Run the following two lines of command.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ jupyter notebook --generate-config
$ jupyter notebook password
</pre></div>
</div>
<p>It will prompt you to enter a password for opening the jupyter notebook on your local machine later. You can simply type a password and you need to remember it!</p>
<p>If the command does not work (often in older versions of Jupyter), there are <a class="reference external" href="http://pangeo.io/setup_guides/hpc.html">instructions</a> on how to set up step-by-step.</p>
</div>
<div class="section" id="Start-a-Jupyter-Notebook-Server">
<h2>Start a Jupyter Notebook Server<a class="headerlink" href="#Start-a-Jupyter-Notebook-Server" title="Permalink to this headline">¶</a></h2>
<p>First create a directory where you will run the jupyter notebook, let’s call it ~/pangeo/tutorial.</p>
<p>Submit a batch job script as below to the queue system. You can create a shell script by copying the following commands into a script file. Let’s name it as run_ipynb_job.sh. Or you can download the example script here. We request 2 notes with 32 CPU and 64GB memory in this instance. Further instructions about job submission and running jobs on Raijin can be found <a class="reference external" href="https://opus.nci.org.au/display/Help/Running+Jobs">here</a>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#PBS -N pangeo_test</span>
<span class="c1">#PBS -q normal</span>
<span class="c1">#PBS -l walltime=5:00:00</span>
<span class="c1">#PBS -l ncpus=32</span>
<span class="c1">#PBS -l mem=64GB</span>
<span class="c1">#PBS -l jobfs=100GB</span>
<span class="n">module</span> <span class="n">load</span> <span class="n">pangeo</span><span class="o">/</span><span class="mf">2019.10</span>
<span class="n">pangeo</span><span class="o">.</span><span class="n">ini</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">sh</span>
<span class="n">sleep</span> <span class="n">infinity</span>
</pre></div>
</div>
<p><img alt="3" src="../../_images/pangeo_setup3.png" /></p>
<p>Please always request one or multiple whole nodes in your job script. The above job will load the pangeo module, run the initialization script called <strong>pangeo.ini.all.sh</strong>, and keep alive in the job lifetime. The initialization script will set up the dask scheduler at one node and multiple workers on all nodes. After that, it will start up the jupyter lab and create port forwarding commands for the user by putting them into a file named ‘client_cmd’ .</p>
</div>
<div class="section" id="Set-up-port-forwarding-at-the-client-machine">
<h2>Set up port forwarding at the client machine<a class="headerlink" href="#Set-up-port-forwarding-at-the-client-machine" title="Permalink to this headline">¶</a></h2>
<p>Once the job is complete, there are two files appearing in your current directory.</p>
<ul class="simple">
<li>client_cmd</li>
<li>scheduler.json</li>
</ul>
<p><img alt="4" src="../../_images/pangeo_setup4.png" /></p>
<p>The file client_cmd contains commands to forward network traffic from the defined port number of worker node to client machine via the login node raijin.nci.org.au. In the example below, jupyter lab uses port 8343 and dask dashboard occupies port 8890 respectively at the Raijin worker node r225. Note both port numbers are randomly picked up in each job so they keep changing in different job submissions.</p>
</div>
<div class="section" id="SSH-login-with/without-password">
<h2>SSH login with/without password<a class="headerlink" href="#SSH-login-with/without-password" title="Permalink to this headline">¶</a></h2>
<p>You may need to run each command and type in your Raijin password when needed:</p>
<p>CLI_1:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ssh -N -L 8343:r225:8343 jbw900@raijin.nci.org.au
jbw900@raijin.nci.org.au&#39;s password:
</pre></div>
</div>
<p>Then “ctrl Z” and then type</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ bg
</pre></div>
</div>
<p>CLI_2:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ssh -N -L 8890:r225:8890 jbw900@raijin.nci.org.au
jbw900@raijin.nci.org.au&#39;s password:
</pre></div>
</div>
<p>Then “ctrl Z” and then type</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ bg
</pre></div>
</div>
<p>If you have set up the SSH login with trust between the two machines then you could paste the above two lines in one command line interface (CLI) of the client machine (recommend to use VDI or a computer with MAC OS or Linux).</p>
<p><img alt="5" src="../../_images/pangeo_setup5.png" /></p>
</div>
<div class="section" id="Connect-to-the-remote-Jupyter-lab-server-from-your-client-machine">
<h2>Connect to the remote Jupyter lab server from your client machine<a class="headerlink" href="#Connect-to-the-remote-Jupyter-lab-server-from-your-client-machine" title="Permalink to this headline">¶</a></h2>
<p>By typing in “localhost:8343” in a web browser of client machine, you could enter the remote jupyter lab interface.</p>
<p><img alt="6" src="../../_images/pangeo_setup6.png" /></p>
<p>Then it will prompt the password. Type the password that you set up in the second step in this tutorial.</p>
<p><img alt="7" src="../../_images/pangeo_setup7.png" /></p>
<p>Once your authentication passed, a jupyterlab interface will be launched in a few seconds.</p>
<p><img alt="8" src="../../_images/pangeo_setup8.png" /></p>
<p>Now you are ready to run your own notebooks.</p>
</div>
<div class="section" id="Let’s-import-a-notebook-example">
<h2>Let’s import a notebook example<a class="headerlink" href="#Let’s-import-a-notebook-example" title="Permalink to this headline">¶</a></h2>
<p>You can drag and drop a notebook from your local computer into this Jupyterlab. Then the file will also appear in your working directory in Raijin.</p>
<p><img alt="9" src="../../_images/pangeo_setup9.png" /></p>
<p>The screen shot above shows</p>
<ol class="arabic simple">
<li>jupyter notebook interface opened from your local computer</li>
<li>a directory on local computer from where a notebook is dragged and dropped into the Jupyterlab interface</li>
<li>Raijin command window showing the notebook appears instantly</li>
</ol>
</div>
<div class="section" id="Utilize-the-dask-server-in-Jupyter-notebook">
<h2>Utilize the dask server in Jupyter notebook<a class="headerlink" href="#Utilize-the-dask-server-in-Jupyter-notebook" title="Permalink to this headline">¶</a></h2>
<p>To utilize the dask server established from the PBS job, it is necessary to add and run the following cell at the beginning of your notebook:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="k">import</span> <span class="n">Client</span><span class="p">,</span><span class="n">LocalCluster</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">scheduler_file</span><span class="o">=</span><span class="s1">&#39;scheduler.json&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
</pre></div>
</div>
<p>Its output will show configurations of client and cluster. Make sure the number of cores matches what you requested in the job script. Now you could run your notebook as usual.</p>
</div>
<div class="section" id="Terminate-the-job">
<h2>Terminate the job<a class="headerlink" href="#Terminate-the-job" title="Permalink to this headline">¶</a></h2>
<p>After all work finished, add and run a cell as below to stop the job.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!pangeo.end.sh
</pre></div>
</div>
</div>
<div class="section" id="Recap-important-notes">
<h2>Recap important notes<a class="headerlink" href="#Recap-important-notes" title="Permalink to this headline">¶</a></h2>
<p>Please make sure the following two lines are added at the beginning and the end of the notebook.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># start the dask client
client =  Client(scheduler_file=&#39;scheduler.json&#39;)

# stop the pbs job.
! pangeo.end.sh
</pre></div>
</div>
</div>
<div class="section" id="View-threads-using-Dask-dashboard">
<h2>View threads using Dask dashboard<a class="headerlink" href="#View-threads-using-Dask-dashboard" title="Permalink to this headline">¶</a></h2>
<p>Open a new tab in the web browser, type the following, the second port in the client_cmd file. If the job starts running, you should be able to see the dynamic resources of the processing.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">localhost</span><span class="p">:</span><span class="mi">8890</span>
</pre></div>
</div>
<p><img alt="10" src="../../_images/pangeo_setup10.png" /></p>
</div>
<div class="section" id="Run-Jupyter-notebook-in-a-batch-job">
<h2>Run Jupyter notebook in a batch job<a class="headerlink" href="#Run-Jupyter-notebook-in-a-batch-job" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="convert-your-jupyter-notebook-to-a-python-script">
<h2>convert your jupyter notebook to a python script<a class="headerlink" href="#convert-your-jupyter-notebook-to-a-python-script" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">jupyter</span> <span class="n">nbconvert</span> <span class="o">--</span><span class="n">to</span> <span class="n">script</span> <span class="p">[</span><span class="n">YOUR_NOTEBOOK</span><span class="p">}</span><span class="o">.</span><span class="n">ipynb</span>
</pre></div>
</div>
<p>Make sure you have added the following lines at the beginning of the python script.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="k">import</span> <span class="n">Client</span><span class="p">,</span><span class="n">LocalCluster</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">scheduler_file</span><span class="o">=</span><span class="s1">&#39;scheduler.json&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="Create-the-job-script-as-below">
<h2>Create the job script as below<a class="headerlink" href="#Create-the-job-script-as-below" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash
#PBS -N pangeo_test
#PBS -q normal
#PBS -l walltime=5:00:00
#PBS -l ncpus=32
#PBS -l mem=64GB
#PBS -l jobfs=100GB

module load pangeo/2019.10
pangeo.ini.all.sh
source ${PANGEO_ROOT}/etc/profile.d/conda.sh
conda activate pangeo

cd $PBS_O_WORKDIR
python YOUR_PYSCRIPT_NAME.py
pangeo.end.sh
</pre></div>
</div>
<p>Modify parameters that suit your case, and name it as <strong>run_py.sh</strong></p>
</div>
<div class="section" id="Submit-your-job-script-via-‘qsub’-command">
<h2>Submit your job script via ‘qsub’ command<a class="headerlink" href="#Submit-your-job-script-via-‘qsub’-command" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">qsub</span> <span class="n">run_py</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
</div>
<div class="section" id="Reference">
<h2>Reference<a class="headerlink" href="#Reference" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://pangeo.io">http://pangeo.io</a></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, NCI

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>